// Mobile Navigation Toggle
document.addEventListener('DOMContentLoaded', function() {
    // Ensure proper positioning on page load for mobile devices
    if (window.innerWidth <= 768) {
        // Small delay to ensure page is fully loaded
        setTimeout(() => {
            const currentPath = window.location.pathname;
            const isHomePage = currentPath === '/' || currentPath.includes('index.html') || currentPath === '';
            
            if (isHomePage && window.location.hash === '') {
                // If we're on home page without hash, ensure we're at the top
                window.scrollTo(0, 0);
            }
        }, 100);
    }
    const burgerMenu = document.querySelector('.burger-menu');
    const navMenu = document.querySelector('.nav-menu');
    
    if (burgerMenu && navMenu) {
        burgerMenu.addEventListener('click', function() {
            burgerMenu.classList.toggle('active');
            navMenu.classList.toggle('active');
        });
        
        // Close mobile menu when clicking on a link
        const navLinks = document.querySelectorAll('.nav-menu a');
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                burgerMenu.classList.remove('active');
                navMenu.classList.remove('active');
                
                // If it's an internal link, handle scroll offset
                const href = link.getAttribute('href');
                if (href && href.includes('.html')) {
                    // For main page navigation, scroll to top after page loads
                    if (href === 'index.html' && window.location.pathname.includes('index.html') === false) {
                        setTimeout(() => {
                            window.scrollTo({
                                top: 0,
                                behavior: 'smooth'
                            });
                        }, 100);
                    }
                    // For other page navigation, let it proceed normally
                    return;
                }
                
                // For anchor links within the same page
                if (href && href.startsWith('#')) {
                    e.preventDefault();
                    const targetId = href.substring(1);
                    const targetElement = document.getElementById(targetId);
                    
                    if (targetElement) {
                        setTimeout(() => {
                            const headerHeight = document.querySelector('.header').offsetHeight;
                            const elementPosition = targetElement.getBoundingClientRect().top;
                            const offsetPosition = elementPosition + window.pageYOffset - headerHeight - 20;

                            window.scrollTo({
                                top: offsetPosition,
                                behavior: 'smooth'
                            });
                        }, 300); // Small delay to let menu close first
                    }
                }
            });
        });
        
        // Close mobile menu when clicking outside
        document.addEventListener('click', function(event) {
            if (!burgerMenu.contains(event.target) && !navMenu.contains(event.target)) {
                burgerMenu.classList.remove('active');
                navMenu.classList.remove('active');
            }
        });
    }

    // Header scroll effect
    const header = document.querySelector('.header');
    if (header) {
        window.addEventListener('scroll', function() {
            if (window.scrollY > 100) {
                header.classList.add('scrolled');
            } else {
                header.classList.remove('scrolled');
            }
        });
    }

    // FAQ Toggle
    const faqItems = document.querySelectorAll('.faq-item');
    faqItems.forEach(item => {
        item.querySelector('.faq-question').addEventListener('click', () => {
            item.classList.toggle('active');
        });
    });
    
    // üöÄ –ù–û–í–ê–Ø –°–ò–°–¢–ï–ú–ê –û–¢–ü–†–ê–í–ö–ò –ü–ò–°–ï–ú
    const contactForm = document.getElementById('contactForm');
    if (contactForm) {
        contactForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Get form data
            const formData = new FormData(contactForm);
            const submitButton = contactForm.querySelector('.form-submit');
            const originalButtonText = submitButton.textContent;
            
            // Basic form validation
            const name = document.getElementById('name').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const privacy = document.getElementById('privacy').checked;
            
            if (!name) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è');
                return;
            }
            
            if (!phone) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞');
                return;
            }
            
            if (!privacy) {
                alert('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö');
                return;
            }
            
            // Disable submit button and show loading
            submitButton.disabled = true;
            submitButton.textContent = '–û—Ç–ø—Ä–∞–≤–ª—è–µ–º...';
            
            try {
                // Prepare data for sending
                const data = {
                    name: formData.get('name'),
                    phone: formData.get('phone'),
                    email: formData.get('email'),
                    service: formData.get('service'),
                    message: formData.get('message')
                };
                
                // üéØ –ò–°–ü–û–õ–¨–ó–£–ï–ú –ù–û–í–£–Æ –°–ò–°–¢–ï–ú–£ –û–¢–ü–†–ê–í–ö–ò
                let result;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≥—Ä—É–∂–µ–Ω –ª–∏ –º–æ–¥—É–ª—å –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–∏—Å–µ–º
                if (typeof window.sendEmailFree === 'function') {
                    console.log('üöÄ –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—É—é —Å–∏—Å—Ç–µ–º—É –æ—Ç–ø—Ä–∞–≤–∫–∏');
                    result = await window.sendEmailFree(data);
                } else {
                    // –†–µ–∑–µ—Ä–≤–Ω—ã–π —Å–ø–æ—Å–æ–± - –∑–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥—É–ª—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
                    console.log('üì¶ –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥—É–ª—å –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–∏—Å–µ–º...');
                    try {
                        const script = document.createElement('script');
                        script.src = 'send_email_free.js';
                        document.head.appendChild(script);
                        
                        await new Promise((resolve) => {
                            script.onload = resolve;
                        });
                        
                        if (typeof window.sendEmailFree === 'function') {
                            result = await window.sendEmailFree(data);
                        } else {
                            throw new Error('–ú–æ–¥—É–ª—å –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è');
                        }
                    } catch (moduleError) {
                        console.log('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥—É–ª—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–∞–∑–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ');
                        result = await basicEmailSolution(data);
                    }
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                if (result.success) {
                    alert(result.message);
                    contactForm.reset();
                } else {
                    alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + result.error);
                }
                
            } catch (error) {
                console.error('–û–±—â–∞—è –æ—à–∏–±–∫–∞:', error);
                
                // –ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–µ–∑–µ—Ä–≤ - –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
                const fallbackResult = await basicEmailSolution({
                    name: formData.get('name'),
                    phone: formData.get('phone'),
                    email: formData.get('email'),
                    service: formData.get('service'),
                    message: formData.get('message')
                });
                
                alert(fallbackResult.message);
                if (fallbackResult.success) {
                    contactForm.reset();
                }
                
            } finally {
                // Restore submit button
                submitButton.disabled = false;
                submitButton.textContent = originalButtonText;
            }
        });
        
        // Phone number formatting
        const phoneInput = document.getElementById('phone');
        if (phoneInput) {
            phoneInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 0) {
                    if (value[0] === '8') {
                        value = '7' + value.slice(1);
                    }
                    if (value[0] === '7') {
                        value = value.replace(/^7(\d{0,3})(\d{0,3})(\d{0,2})(\d{0,2})/, function(match, p1, p2, p3, p4) {
                            let formatted = '+7';
                            if (p1) formatted += ' (' + p1;
                            if (p2) formatted += ') ' + p2;
                            if (p3) formatted += '-' + p3;
                            if (p4) formatted += '-' + p4;
                            return formatted;
                        });
                    }
                }
                e.target.value = value;
            });
        }
    }
});

/**
 * üî• –ë–ê–ó–û–í–û–ï –†–ï–®–ï–ù–ò–ï –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–∏—Å–µ–º
 * –†–∞–±–æ—Ç–∞–µ—Ç –≤—Å–µ–≥–¥–∞, –¥–∞–∂–µ –µ—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω–æ–π –º–æ–¥—É–ª—å –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è
 */
async function basicEmailSolution(formData) {
    try {
        // 1. –ü—Ä–æ–±—É–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —á–µ—Ä–µ–∑ EmailJS (–µ—Å–ª–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞)
        if (typeof emailjs !== 'undefined') {
            const serviceNames = {
                'video': '–í–∏–¥–µ–æ–Ω–∞–±–ª—é–¥–µ–Ω–∏–µ',
                'access': '–ö–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞',
                'intercom': '–î–æ–º–æ—Ñ–æ–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã',
                'alarm': '–û—Ö—Ä–∞–Ω–Ω–∞—è —Å–∏–≥–Ω–∞–ª–∏–∑–∞—Ü–∏—è',
                'automation': '–ê–≤—Ç–æ–º–∞—Ç–∏–∫–∞ –≤–æ—Ä–æ—Ç',
                'scs': '–°–ö–°',
                'consultation': '–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è',
                'other': '–î—Ä—É–≥–æ–µ'
            };
            
            const serviceName = serviceNames[formData.service] || formData.service || '–ù–µ –≤—ã–±—Ä–∞–Ω–∞';
            
            try {
                const response = await emailjs.send(
                    'service_rem_insait', // Service ID
                    'template_rem_insait', // Template ID
                    {
                        client_name: formData.name,
                        client_phone: formData.phone,
                        client_email: formData.email || '–ù–µ —É–∫–∞–∑–∞–Ω',
                        service_type: serviceName,
                        message: formData.message || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                        to_email: 'Ange1Nikita@yandex.ru',
                        date_time: new Date().toLocaleString('ru-RU')
                    }
                );
                
                return {
                    success: true,
                    message: `‚úÖ –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ —á–µ—Ä–µ–∑ EmailJS!\n\n–ü–∏—Å—å–º–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ Ange1Nikita@yandex.ru\n\n–ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è!`
                };
            } catch (emailjsError) {
                console.log('EmailJS –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª:', emailjsError);
            }
        }
        
        // 2. –õ–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–∫ —Ä–µ–∑–µ—Ä–≤
        const submissions = JSON.parse(localStorage.getItem('form_submissions') || '[]');
        const submission = {
            ...formData,
            timestamp: new Date().toISOString(),
            id: Date.now()
        };
        submissions.push(submission);
        localStorage.setItem('form_submissions', JSON.stringify(submissions));
        
        const serviceNames = {
            'video': '–í–∏–¥–µ–æ–Ω–∞–±–ª—é–¥–µ–Ω–∏–µ',
            'access': '–ö–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞',
            'intercom': '–î–æ–º–æ—Ñ–æ–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã',
            'alarm': '–û—Ö—Ä–∞–Ω–Ω–∞—è —Å–∏–≥–Ω–∞–ª–∏–∑–∞—Ü–∏—è',
            'automation': '–ê–≤—Ç–æ–º–∞—Ç–∏–∫–∞ –≤–æ—Ä–æ—Ç',
            'scs': '–°–ö–°',
            'consultation': '–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è',
            'other': '–î—Ä—É–≥–æ–µ'
        };
        
        const serviceName = serviceNames[formData.service] || formData.service || '–ù–µ –≤—ã–±—Ä–∞–Ω–∞';
        
        return {
            success: true,
            message: `üìã –ó–ê–Ø–í–ö–ê –°–û–•–†–ê–ù–ï–ù–ê!\n\n` +
                    `üë§ –ò–º—è: ${formData.name}\n` +
                    `üìû –¢–µ–ª–µ—Ñ–æ–Ω: ${formData.phone}\n` +
                    `üìß Email: ${formData.email || '–ù–µ —É–∫–∞–∑–∞–Ω'}\n` +
                    `üõ†Ô∏è –£—Å–ª—É–≥–∞: ${serviceName}\n` +
                    `üí¨ –°–æ–æ–±—â–µ–Ω–∏–µ: ${formData.message || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}\n\n` +
                    `üìä –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞—è–≤–æ–∫: view_submissions.html\n\n` +
                    `üìû –°–≤—è–∂–∏—Ç–µ—Å—å –Ω–∞–ø—Ä—è–º—É—é:\n` +
                    `–¢–µ–ª–µ—Ñ–æ–Ω: +7 989 123 39 53\n` +
                    `Email: Ange1Nikita@yandex.ru`
        };
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –±–∞–∑–æ–≤–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è:', error);
        return {
            success: false,
            error: '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É'
        };
    }
}

// Utility function to check if element is in viewport
function isInViewport(element) {
    const rect = element.getBoundingClientRect();
    return (
        rect.top >= 0 &&
        rect.left >= 0 &&
        rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
        rect.right <= (window.innerWidth || document.documentElement.clientWidth)
    );
}

// Animation on scroll
window.addEventListener('scroll', function() {
    const animatedElements = document.querySelectorAll('.product-card, .brand-card, .service-card, .advantage-item');
    
    animatedElements.forEach(element => {
        if (isInViewport(element) && !element.classList.contains('animated')) {
            element.classList.add('animated');
            element.style.opacity = '1';
            element.style.transform = 'translateY(0)';
        }
    });
});
